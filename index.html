<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cotizador Royal Prestige Innove, Hilago SRL 2024</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* Custom scrollbar for product list */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #059669; /* emerald-600 */
            border-radius: 3px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background-color: #e5e7eb; /* gray-200 */
        }
        /* Style for the fixed quote summary on mobile */
        @media (max-width: 767px) {
            #quote-summary {
                position: sticky;
                bottom: 0;
                z-index: 20;
                padding: 0.75rem;
                border-top: 1px solid #d1d5db; /* gray-300 */
            }
        }
    </style>
</head>
<body class="min-h-screen">

    <div class="max-w-7xl mx-auto p-4 md:p-8">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-extrabold text-emerald-700 tracking-tight">Hilago,SRL. 809-893-6842</h1>
            <p class="text-gray-500 mt-1">Herramienta de cotizaci√≥n de Royal Prestige 2024</p>
	    
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg h-[80vh] flex flex-col">
                <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Cat√°logo de Productos</h2>
                
                <div class="flex flex-col sm:flex-row gap-4 mb-4">
                    <input type="text" id="product-search" placeholder="Buscar por nombre o SKU..." class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 transition duration-150">
                    <select type="text" id="category-filter" class="p-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 transition duration-150 sm:w-1/3">
                        <option value="">Todas las Categor√≠as</option>
                        </select>
                </div>

                <div id="product-list" class="flex-grow overflow-y-auto custom-scroll space-y-3">
                    <p class="text-center text-gray-500 pt-4">Cargando productos...</p>
                </div>
            </div>

            <div class="lg:col-span-1">
                <div id="quote-summary" class="bg-white rounded-xl shadow-xl border border-emerald-100">
                    <div class="p-6">
                        <h2 class="text-xl font-bold text-emerald-700 mb-4 border-b pb-2">Resumen de Cotizaci√≥n</h2>
                        
                        <div id="quote-items" class="min-h-[100px] max-h-[250px] overflow-y-auto custom-scroll space-y-3 mb-4">
                            <p id="empty-quote-message" class="text-center text-gray-400 mt-6 italic">A√±ade productos del cat√°logo.</p>
                            </div>

                        <div class="space-y-2 border-t pt-4">
                            <div class="flex justify-between font-medium text-gray-600">
                                <span>Subtotal:</span>
                                <span id="subtotal-display">$0.00</span>
                            </div>

                            <div class="flex justify-between items-center">
                                <label for="discount-percentage" class="text-gray-600">
                                    Descuento (%):
                                </label>
                                <input type="number" id="discount-percentage" value="0" min="0" max="100" class="w-16 text-right p-1 border border-gray-300 rounded-lg">
                            </div>
                            <div class="flex justify-between font-medium text-red-500 border-b pb-2">
                                <span>Descuento Aplicado:</span>
                                <span id="discount-amount-display">-$0.00</span>
                            </div>

                            <div class="flex justify-between font-bold text-2xl text-emerald-600 pt-2">
                                <span>Total a Pagar:</span>
                                <span id="total-display">$0.00</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6 bg-yellow-50 rounded-b-xl border-t border-yellow-200">
                        <h3 class="text-lg font-bold text-yellow-800 mb-3">Control de Regalos por Volumen (Max 10%)</h3>

                        <div class="flex justify-between font-medium text-gray-700">
                            <span>Valor Total de Regalos A√±adidos:</span>
                            <span id="gift-total-display" class="font-bold">$0.00</span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-600 mb-2">
                            <span>Valor M√°ximo Permitido (10% del Total):</span>
                            <span id="gift-max-display">$0.00</span>
                        </div>
                   
                        <div id="gift-warning-message" class="mt-3 p-3 text-center rounded-lg font-semibold hidden">
                            </div>
                    </div>

                    <div class="p-6 bg-emerald-50 rounded-b-xl border-t border-emerald-200">
                        <h3 class="text-lg font-bold text-emerald-700 mb-3">Opciones de Financiamiento</h3>

                        <div class="flex justify-between items-center mb-4">
                            <label for="interest-rate" class="text-gray-700 font-medium">Tasa de Inter√©s Anual (%):</label>
                            <input type="number" id="interest-rate" value="31" min="0" max="100" step="0.5" class="w-20 text-right p-1 border border-gray-300 rounded-lg">
                        </div>

                        <div class="mb-4">
                            <label for="initial-payment" class="text-gray-700 font-medium block mb-2">Pago Inicial:</label>
                            <div class="flex gap-2 mb-2">
                                <button data-percent="5" class="preset-initial-btn flex-1 py-1 px-3 text-sm rounded-full bg-emerald-200 text-emerald-800 hover:bg-emerald-300 transition duration-150">5%</button>
                                <button data-percent="10" class="preset-initial-btn flex-1 py-1 px-3 text-sm rounded-full bg-emerald-200 text-emerald-800 hover:bg-emerald-300 transition duration-150">10%</button>
                                <button data-percent="20" class="preset-initial-btn flex-1 py-1 px-3 text-sm rounded-full bg-emerald-200 text-emerald-800 hover:bg-emerald-300 transition duration-150">20%</button>
                                <button data-percent="30" class="preset-initial-btn flex-1 py-1 px-3 text-sm rounded-full bg-emerald-200 text-emerald-800 hover:bg-emerald-300 transition duration-150">30%</button>
                            </div>
                            <input type="number" id="initial-payment" value="0" min="0" class="w-full text-right p-2 border border-gray-300 rounded-lg">
                            <p id="initial-payment-percent-display" class="text-sm text-gray-500 text-right mt-1"></p>

                            <div id="initial-payment-warning" class="mt-2 p-2 text-center rounded-lg font-medium text-red-800 bg-red-100 hidden">
                                ‚ö†Ô∏è El Pago Inicial m√≠nimo debe ser del 5% del Total a Pagar.
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <p class="text-gray-700 font-medium mb-2">Plazo (Meses):</p>
                            <div class="flex flex-wrap gap-2">
                                <label class="flex items-center space-x-2 bg-white border border-emerald-500 rounded-lg p-2 cursor-pointer transition duration-150 hover:bg-emerald-50">
                                    <input type="radio" name="term" value="12" class="term-radio text-emerald-600 focus:ring-emerald-500">
                                    <span class="text-sm font-medium">12 Meses</span>
                                </label>
                                <label class="flex items-center space-x-2 bg-white border border-emerald-500 rounded-lg p-2 cursor-pointer transition duration-150 hover:bg-emerald-50">
                                    <input type="radio" name="term" value="18" class="term-radio text-emerald-600 focus:ring-emerald-500">
                                    <span class="text-sm font-medium">18 Meses</span>
                                </label>
                                <label class="flex items-center space-x-2 bg-white border border-emerald-500 rounded-lg p-2 cursor-pointer transition duration-150 hover:bg-emerald-50" checked>
                                    <input type="radio" name="term" value="24" class="term-radio text-emerald-600 focus:ring-emerald-500" checked>
                                    <span class="text-sm font-medium">24 Meses</span>
                                </label>
                                <label class="flex items-center space-x-2 bg-white border border-emerald-500 rounded-lg p-2 cursor-pointer transition duration-150 hover:bg-emerald-50">
                                    <input type="radio" name="term" value="31" class="term-radio text-emerald-600 focus:ring-emerald-500">
                                    <span class="text-sm font-medium">31 Meses</span> 
                                </label>
                            </div>
                        </div>

                        <div class="space-y-2 border-t pt-4">
                            <div class="flex justify-between text-gray-600">
                                <span>Monto a Financiar:</span>
                                <span id="amount-financed-display">$0.00</span>
                            </div>
                            <div class="flex justify-between font-bold text-xl text-emerald-700">
                                <span>Pago Mensual Estimado:</span>
                                <span id="monthly-payment-display">$0.00</span>
                            </div>
                        </div>

                        <button id="clear-quote-button" class="w-full mt-4 py-2 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600 transition duration-150 shadow-md">
                            Limpiar Cotizaci√≥n
                        </button>
                    </div>
                    
                    <div class="p-6 bg-blue-50 rounded-b-xl border-t border-blue-200">
                        <h3 class="text-lg font-bold text-blue-700 mb-3">Enviar Cotizaci√≥n</h3>
                        <input type="text" id="client-name" placeholder="Nombre del Cliente (Opcional)" class="w-full p-2 mb-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                        <input type="tel" id="client-whatsapp" placeholder="N√∫mero de WhatsApp (Ej: 8098936842)" class="w-full p-2 mb-4 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                        
                        <button id="send-whatsapp-button" class="w-full py-3 bg-green-500 text-white font-extrabold text-lg rounded-lg hover:bg-green-600 transition duration-150 shadow-lg flex items-center justify-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                                <path d="M12.001 2c-5.522 0-9.999 4.477-9.999 9.999s4.477 9.999 9.999 9.999h-.001c1.472 0 2.92-.32 4.237-.936l1.371.492 4.076 1.46c.307.11.642.164.978.164.254 0 .507-.031.751-.093.593-.15 1.054-.611 1.204-1.205.062-.244.093-.497.093-.751 0-.336-.054-.67-.164-.978l-1.46-4.076-.492-1.371c.616-1.317.936-2.765.936-4.237 0-5.522-4.477-9.999-9.999-9.999zm4.722 13.911c.209.132.417.228.625.291.208.062.404.088.588.088.077 0 .15-.008.219-.015s.138-.016.208-.031c.224-.055.448-.152.673-.292.224-.138.403-.314.536-.525.132-.212.198-.445.198-.711 0-.154-.031-.322-.093-.504-.062-.182-.178-.372-.348-.571-.17-.2-.395-.452-.676-.755-.281-.303-.615-.694-1.004-1.171-.389-.478-.857-.962-1.403-1.455-.546-.492-1.127-1.002-1.743-1.528-.615-.525-1.209-.997-1.782-1.417-.572-.42-1.077-.736-1.514-.946-.436-.21-.861-.314-1.272-.314-.146 0-.322.022-.53.065-.208.044-.403.116-.588.215-.184.1-.349.231-.497.393s-.273.344-.367.558c-.093.214-.14.453-.14.717 0 .285.077.587.23.905.153.318.39.697.711 1.137.32.44.721.954 1.203 1.542.482.589 1.05 1.267 1.704 2.035.655.767 1.341 1.63 2.059 2.587.719.957 1.391 1.879 2.016 2.766.625.887 1.189 1.674 1.694 2.361z"/>
                            </svg>
                            <span>Enviar por WhatsApp</span>
                        </button>
                    </div>
                </div>
            </div>

<script>
    // Variable global para almacenar el carrito de cotizaci√≥n
    let quote = {
        items: [],
        discountPercentage: 0,
        interestRate: 0,
        initialPayment: 0,
        termMonths: 24
    };
    // Constante para el l√≠mite del regalo (10% del total final)
    const GIFT_LIMIT_PERCENTAGE = 0.10; // 10%
    // Constante para el pago inicial m√≠nimo (5% del total final)
    const MINIMUM_INITIAL_PAYMENT_PERCENTAGE = 0.05; // 5%

    // Funci√≥n para formatear a moneda (Peso Mexicano - MXN)
    const formatter = new Intl.NumberFormat('es-MX', {
        style: 'currency',
        currency: 'MXN',
        minimumFractionDigits: 2
    });
    // Cat√°logo de Productos (DATOS ACTUALIZADOS CON LA LISTA EXTENSA DEL USUARIO)
    const productCatalog = [
        // AROS SILICROMATICOS (A√±adido)
        { sku: 'SP0420', name: 'Aro 16 cm. y ventana Innove', price: 1700, category: 'Accesorios Innove' },
        { sku: 'SP0430', name: 'Aro 20 cm. y ventana Innove', price: 1800, category: 'Accesorios Innove' },
        { sku: 'SP0440', name: 'Aro 26 cm. y ventana Innove', price: 2200, category: 'Accesorios Innove' },
        { sku: 'SP0450', name: 'Aro 30 cm. y ventana Innove', price: 2400, category: 'Accesorios Innove' },
        { sku: 'SP0460', name: 'Aro 35 cm. y ventana Innove', price: 2800, category: 'Accesorios Innove' },
        { sku: 'SP0470', name: 'Aro 38 cm. y ventana Innove', price: 3000, category: 'Accesorios Innove' },
        { sku: 'SP0488', name: 'Aros para tapas Altas Innove', price: 2000, category: 'Accesorios Innove' },

        // JUEGOS DE OLLAS POR DEFECTO EN SU CAJA (A√±adido)
        { sku: 'CO9245', name: 'Sistema de Cocina Complem. de 5 Pzs Innove', price: 111000, category: 'Sistemas de Cocina Innove' },
        { sku: 'CO9247', name: 'Sistema de Cocina Complem. de 5 Pzs Innove + Perfect Pop', price: 119200, category: 'Sistemas de Cocina Innove' },
        { sku: 'CO9253', name: 'Sistema de Cocina Cl√°sico de 7 Pzs Innove', price: 137500, category: 'Sistemas de Cocina Innove' },
        { sku: 'CO9254', name: 'Sistema de Cocina Especial de 8 Pzs Innove', price: 168500, category: 'Sistemas de Cocina Innove' },
        { sku: 'CO9261', name: 'Sistema de Cocina Familiar de 10 Pzs Innove + Perfect Pop', price: 215000, category: 'Sistemas de Cocina Innove' },

        // JUEGOS DE OLLAS + TAPA ADICIONAL (A√±adido) - SKUs gen√©ricos
        { sku: 'CO9248', name: 'Sist. de Cocina Complementario de 5 Pzs Innove + Tapa Grand. 26cm', price: 125500, category: 'Sistemas de Cocina Innove' },
        { sku: 'CO9255', name: 'Sist. de Cocina Cl√°sico de 7 Pzs Innove + Tapa Med. 20 Cm', price: 150000, category: 'Sistemas de Cocina Innove' },
        { sku: 'CO9262', name: 'Sist. de Cocina Familiar de 10 Pzs Innove + Perfect Pop + Tapa Med. 20 Cm', price: 227500, category: 'Sistemas de Cocina Innove' },

        // OLLAS DE SANCOCHO (A√±adido)
        { sku: 'CO9224', name: 'Olla Innove de 12 Qt. c/tapa Sancocho Peq.', price: 53000, category: 'Sancocho' },
        { sku: 'CO9226', name: 'Olla Innove de 20 Qt. c/tapa Sancocho Med.', price: 65000, category: 'Sancocho' },
        { sku: 'CO9228', name: 'Olla Innove 30 QT/38 cm c/tapa Sancocho Grand.', price: 80000, category: 'Sancocho' },

        // PIEZAS INDIVIDUALES (A√±adido)
        { sku: 'CO9201', name: 'Olla Innove de 2 Qt. Innove (Sin Tapa)', price: 20000, category: 'Piezas Individuales' },
        { sku: 'CO9202T', name: 'Olla Innove de 2 Qt. Con Tapa', price: 31500, category: 'Piezas Individuales' },
        { sku: 'CO9203', name: 'Olla Innove de 3 Qt. Innove (Sin Tapa)', price: 26500, category: 'Piezas Individuales' },
        { sku: 'CO9204T', name: 'Olla Innove de 3 Qt. Con Tapa', price: 39000, category: 'Piezas Individuales' },
        { sku: 'CO9205', name: 'Olla Innove de 4 Qt. Innove (Sin Tapa)', price: 26700, category: 'Piezas Individuales' },
        { sku: 'CO9236', name: 'Olla Innove de 4 Qt. Con Tapa', price: 39800, category: 'Piezas Individuales' },
        { sku: 'CO9207', name: 'Olla Innove de 6 Qt. Innove (Sin Tapa)', price: 32500, category: 'Piezas Individuales' },
        { sku: 'CO9209', name: 'Olla Innove de 8 Qt. Innove (Sin Tapa)', price: 35000, category: 'Piezas Individuales' },
        { sku: 'CO9237', name: 'Olla Innove de 8 Qt. Con Tapa', price: 48000, category: 'Piezas Individuales' },
        { sku: 'CO9211', name: 'Sart√©n Innove de 8" Innove (Sin Tapa)', price: 26500, category: 'Piezas Individuales' },
        { sku: 'CO9212T', name: 'Sart√©n Innove de 8" Con Tapa', price: 39000, category: 'Piezas Individuales' },
        { sku: 'CO9213', name: 'Sart√©n Innove de 10.5" / 4QT / 26cm (Sin Tapa)', price: 33500, category: 'Piezas Individuales' },
        { sku: 'CO9214T', name: 'Sart√©n Innove de 10.5" / 4QT / 26cm Con Tapa', price: 48000, category: 'Piezas Individuales' },
        { sku: 'CO9217', name: 'Paellera Innove de 10" con tapa 316L', price: 35500, category: 'Piezas Individuales' },
        { sku: 'CO9215', name: 'Paellera Innove de 14" con tapa 316L', price: 58000, category: 'Piezas Individuales' },
        { sku: 'CO9076', name: 'Colador Peque√±o Innove de 20 cm.', price: 14800, category: 'Piezas Individuales' },
        { sku: 'CO9080', name: 'Colador Grande Innove de 26 cm.', price: 16800, category: 'Piezas Individuales' },

        // TAPAS (A√±adido)
        { sku: 'CO9085', name: 'Tapa Peque√±a Innove de 16 cm.', price: 11500, category: 'Tapas' },
        { sku: 'CO9086', name: 'Tapa Mediana Innove de 20 cm.', price: 12500, category: 'Tapas' },
        { sku: 'CO9087', name: 'Tapa Grande Innove de 26 cm.', price: 14500, category: 'Tapas' },
        { sku: 'CO9088', name: 'Tapa Alta Innove de 26 cm.', price: 27000, category: 'Tapas' },
        { sku: 'CO6500', name: 'Tapa Peque√±a de 16 cm 5 y 9 Capas (modelo anterior)', price: 5700, category: 'Tapas Ant.' },
        { sku: 'CO6505', name: 'Tapa 20 cm. (modelo anterior)', price: 6500, category: 'Tapas Ant.' }, // Se ajust√≥ el nombre
        { sku: 'CO6510', name: 'Tapa Grande de 26 cm 5 y 9 Capas (modelo anterior)', price: 8500, category: 'Tapas Ant.' },
        { sku: 'CO6516', name: 'Tapa Alta - 26 cm C/Base 5 y 9 Capas (modelo anterior)', price: 18500, category: 'Tapas Ant.' },
        { sku: 'PR0025', name: 'Aro 35 cm. y ventana Innove (Regalo/Accesorio)', price: 8000, category: 'Accesorios Innove' }, // Repetido, se asigna a Accesorios

        // OTROS PRODUCTOS (A√±adido)
        { sku: 'PR1675', name: 'Hervidor de 1/2 Qt- 5 Capas Mango Negro', price: 8500, category: 'Otros Productos' },
        { sku: 'PR1685', name: 'Hervidor de 1 Qt- 5 Capas Mango Negro', price: 9500, category: 'Otros Productos' },
        { sku: 'SP0145', name: 'Recipiente / Organizador para Utensilios', price: 2500, category: 'Otros Productos' },
        { sku: 'PR0196', name: 'Utensilios de Cocina de 6 pzs', price: 10700, category: 'Otros Productos' },
        { sku: 'SP0135', name: 'Juego de 4 Tazas Con Pared de Doble', price: 6500, category: 'Otros Productos' },
        { sku: 'SP0136', name: 'Juego de 2 Tazas 16 oz. con Pared Doble', price: 5000, category: 'Otros Productos' },
        { sku: 'CO6589', name: 'Pavera Ovalada Royal Prestige', price: 55000, category: 'Otros Productos' },
        { sku: 'PR2614', name: 'M√°quina para Ensaladas Royal Prestige', price: 54000, category: 'Otros Productos' },
        { sku: 'LT1199', name: 'Recetario Innove RP-ESP/ING', price: 1000, category: 'Otros Productos' },
        { sku: 'CO2124', name: 'Cacerola para Huevos Royal Prestige', price: 14000, category: 'Otros Productos' },
        { sku: 'SP0305', name: 'Base Magneticas para Ollas', price: 3000, category: 'Otros Productos' },
        { sku: 'SP5050', name: 'Royal Shine - Limpiador Royal Prestige', price: 1000, category: 'Otros Productos' },

        // CAF√â / T√â / CHOCOLATE (A√±adido)
        { sku: 'CO2106', name: 'Cafetera Royal Prestige Barista', price: 42000, category: 'Caf√© / T√© / Chocolate' },
        { sku: 'PR2134', name: 'Kit Completo Baristart', price: 5300, category: 'Caf√© / T√© / Chocolate' },
        { sku: 'CO0801', name: 'Royal Prestige Expertea', price: 38500, category: 'Caf√© / T√© / Chocolate' },
        { sku: 'PR2129', name: 'Cafetera RP (Greca) Royal Espresso 10 Tazas Doble Pared', price: 17000, category: 'Caf√© / T√© / Chocolate' },
        { sku: 'PR2120', name: 'Cafetera RP (Greca) Royal Espresso 4 Tazas', price: 14000, category: 'Caf√© / T√© / Chocolate' },
        { sku: 'CO0101', name: 'Chocolatera RP', price: 26000, category: 'Caf√© / T√© / Chocolate' },

        // Licuadora (A√±adido)
        { sku: 'ES0003', name: 'Power Blender C/ Recetario 120-127v - Licuadora', price: 110000, category: 'Electrodom√©sticos' },
        { sku: 'LT2209', name: 'Recetario Nuevo RP Power Blender - Licuadora', price: 1000, category: 'Accesorios Libros' },
        { sku: 'ES3101', name: 'Precision Cook Estufa Inducci√≥n', price: 67000, category: 'Electrodom√©sticos' },

        // EXTRACTOR DE JUGOS RP (A√±adido)
        { sku: 'JU0026', name: 'Extractor de Jugos de Royal Prestige C/Recetario', price: 115000, category: 'Extractor de Jugos' },
        { sku: 'PR1460', name: '3 Coladores Extractor Jugo RP', price: 18500, category: 'Extractor de Jugos' },
        { sku: 'PR1459', name: 'Exprimidor de (C√≠tricos) Jugo Royal Prestige', price: 9000, category: 'Extractor de Jugos' },
        { sku: 'JU0027', name: 'Extractor de Jugos Completo (Juego)', price: 135000, category: 'Extractor de Jugos' }, // Se asigna SKU gen√©rico
        { sku: 'PR1452', name: '3 Coladores para el Maxtractor (modelo anterior)', price: 17500, category: 'Extractor de Jugos Ant.' },
        { sku: 'LT2258', name: 'Recetario Extractor de Jugos ESP/ING', price: 1000, category: 'Accesorios Libros' },
        { sku: 'SP0252', name: 'Olla Innove de 8 Qt. Con Tapa (Pieza)', price: 4500, category: 'Piezas Individuales' }, // Precio bajo, asignado a Pieza

        // RECIPIENTES / TAZONES / BOWLS (A√±adido)
        { sku: 'SP0066', name: 'Taz√≥n Mezclar De 10 QT C/Tapa Con Base Silicona', price: 8000, category: 'Recipientes' },
        { sku: 'SP0062', name: 'Taz√≥n De 5 QT C/Tapa Doble Pared', price: 6000, category: 'Recipientes' },
        { sku: 'PR1044', name: 'Jgo 4 Tazones P/Mezclar C/Tapas 1, 2, 3 y 5 QT Base Silic', price: 14500, category: 'Recipientes' },
        { sku: 'SP0262', name: 'Jgo 2 Taz√≥nes P/Mezclar con Silicona 2.5 &4 QT. 304SS', price: 7300, category: 'Recipientes' },
        { sku: 'SP0111', name: '6 Recipientes RP C/Capacidad de 2 Tzs - 500ml', price: 2900, category: 'Recipientes' },
        { sku: 'SP0112', name: 'Aro 20 cm. y ventana Innove (Recipientes)', price: 800, category: 'Accesorios Innove' }, // Se asigna SKU gen√©rico
        { sku: 'SP0113', name: 'Jgo 8 Pzs Recip. de Comida RP 4, 8,32,48 OZ', price: 4000, category: 'Recipientes' },

        // PLANCHAS (A√±adido)
        { sku: 'CO9218', name: 'Plancha Cuadrada Doble Innove 316 L (Aro 35 cm. y ventana Innove)', price: 28000, category: 'Planchas' }, // Se ajust√≥ el nombre
        { sku: 'CO9219', name: 'Plancha Redonda Innove 316 L', price: 26000, category: 'Planchas' },
        { sku: 'CO9220', name: 'Plancha Cuadrada sencilla Innove 316 L', price: 22500, category: 'Planchas' },

        // CUBERTERIA (A√±adido)
        { sku: 'SP0081', name: 'Jgo. P/Servir de 3 Pzs Deluxe - 430SS', price: 2300, category: 'Cuberter√≠a' },
        { sku: 'SP0091', name: 'Jgo. P/Servir de 3 Pzs Complementario - 430SS', price: 2300, category: 'Cuberter√≠a' },
        { sku: 'SP0009', name: 'Jgo. de Cubiertos 24 Pzs Americana 18/8', price: 9000, category: 'Cuberter√≠a' },

        // SARTENES GOURMET (A√±adido)
        { sku: 'CO9230', name: 'Sart√©n Gourmet Innove 8"/20CM C/Tapa 316L', price: 24000, category: 'Sartenes Gourmet' },
        { sku: 'CO9232', name: 'Sart√©n Gourmet Innove 10"/25CM C/Tapa 316L', price: 29000, category: 'Sartenes Gourmet' },
        { sku: 'CO9234', name: 'Sart√©n Gourmet Innove 12"/30CM C/Tapa 316 L', price: 41000, category: 'Sartenes Gourmet' },
        { sku: 'CO9265', name: 'Juego de Sartenes Gourmet Innove de 6 pzs', price: 91000, category: 'Sartenes Gourmet' },
        { sku: 'CO9222', name: 'Wok con Tapa Innove', price: 41000, category: 'Sartenes Gourmet' },

        // SARTENES EASY RELEASE / VIDRIO (A√±adido)
        { sku: 'CO9732', name: 'Easy Release 8" Peq C/ Tapa Vidrio + 3PZ Utensilios', price: 38500, category: 'Easy Release Vidrio' },
        { sku: 'CO9733', name: 'Easy Release 10" Med C/ Tapa Vidrio + 3PZ Utensilios', price: 47000, category: 'Easy Release Vidrio' },
        { sku: 'CO9734', name: 'Easy Release 12" Grad. C/ Tapa Vidrio + 3PZ Utensilios', price: 58500, category: 'Easy Release Vidrio' },
        { sku: 'CO9726', name: 'Juego Easy Release 6 Pzs C/ Tapa Vidrio + 3PZ Utensilios', price: 129500, category: 'Easy Release Vidrio' },

        // OLLAS EASY RELEASE / VIDRIO (A√±adido)
        { sku: 'CO9777', name: 'Olla 2 Qt /18Cm Easy Release C/ Tapa Vdrio + 3PZ Utensilios', price: 38000, category: 'Easy Release Vidrio' },
        { sku: 'CO9778', name: 'Olla 3 Qt /20Cm Easy Release C/ Tapa Vdrio + 3PZ Utensilios', price: 41000, category: 'Easy Release Vidrio' },
        { sku: 'CO9779', name: 'Jgo. Ollas Easy Release 6PZ C/Tapa Vidrio + 3PZ Utensilios', price: 127000, category: 'Easy Release Vidrio' }, // Se asigna SKU gen√©rico
        { sku: 'SP0018', name: 'Jgo Utensilios 3PZ Easy Release', price: 6000, category: 'Accesorios' },

        // EASY RELEASE / ACERO (A√±adido)
        { sku: 'CO9718', name: 'Juego Easy Release 6 Pzs Tapa Acero + Jgo Utensilios 3 Pzs', price: 115000, category: 'Easy Release Acero' },
        { sku: 'CO9714', name: 'Easy Release 12" Grad. C/ Tapa Acero + 3PZ Utensilios', price: 58500, category: 'Easy Release Acero' },

        // OLLAS DE PRESI√ìN (A√±adido)
        { sku: 'CO1251', name: 'Nueva Olla Presi√≥n de 6 Litros', price: 53500, category: 'Ollas de Presi√≥n' },
        { sku: 'CO1255', name: 'Nueva Olla de Presi√≥n de 10 Litros', price: 63000, category: 'Ollas de Presi√≥n' },

        // CUCHILLER√çA (A√±adido)
        { sku: 'CU0800', name: 'Precisi√≥n B√°sico 5 pzs Serie III', price: 23000, category: 'Cuchiller√≠a' },
        { sku: 'CU0815', name: 'Precisi√≥n para Rebanar 4 pzs Serie III (Parrillero)', price: 18000, category: 'Cuchiller√≠a' },
        { sku: 'CU0820', name: 'Afilador de Cuchillos Precision III', price: 12000, category: 'Cuchiller√≠a' }, // Se ajust√≥ el nombre
        { sku: 'CU0056', name: 'Bloque de Cuchillos 17 Hoyos (S√≥lo bloque)', price: 16500, category: 'Cuchiller√≠a' },
        { sku: 'CU0810', name: 'Cuchillo p/ Pelar 2.75"', price: 6000, category: 'Cuchiller√≠a' },
        { sku: 'CU0814', name: 'Cuchillo Multiuso 4.5" Precision III', price: 6700, category: 'Cuchiller√≠a' }, // Se ajust√≥ el nombre
        { sku: 'CU0831', name: 'Juego completo de cuchillos Precisi√≥n Serie III', price: 82000, category: 'Cuchiller√≠a' },
        { sku: 'CU0825', name: 'Hacha de Cocina 7" Precision Series III', price: 8000, category: 'Cuchiller√≠a' },
        { sku: 'SP0296', name: 'Cuchillo Santoku de 5" - Precision Serie III', price: 3700, category: 'Cuchiller√≠a' },
        { sku: 'SP0297', name: 'Cuchillo Santoku de 3.5" - Precision Serie III', price: 2500, category: 'Cuchiller√≠a' },
        { sku: 'PR0008', name: 'Tabla Grande P/Cortar de Bamb√∫ Silicona - Rojo', price: 8200, category: 'Cuchiller√≠a' },
        { sku: 'PR0021', name: 'Tabla Peque√±a P/Cortar de Bamb√∫ Silicona - Verde', price: 6500, category: 'Cuchiller√≠a' },
        
        // ACCESORIOS DE COCINA - PS III (A√±adido)
        { sku: 'SP1850', name: 'Destapador Precision Series', price: 2500, category: 'Accesorios PS III' },
        { sku: 'SP1851', name: 'Rallador Precision Series', price: 2700, category: 'Accesorios PS III' },
        { sku: 'SP1852', name: 'Esp√°tula Precision Series', price: 2800, category: 'Accesorios PS III' },
        { sku: 'SP1853', name: 'Cucharon Precision Series', price: 3100, category: 'Accesorios PS III' },
        { sku: 'SP1854', name: 'Tenedor de Cocina Precision Series', price: 2900, category: 'Accesorios PS III' },
        { sku: 'SP1855', name: 'Cuchara para Servir Precision Series', price: 3000, category: 'Accesorios PS III' },
        { sku: 'SP1856', name: 'Pelador Precision Series', price: 2500, category: 'Accesorios PS III' },
        { sku: 'SP1857', name: 'Mazo Precision Series', price: 3000, category: 'Accesorios PS III' },
        { sku: 'SP1858', name: 'Cuchara de Helado Precision Series', price: 2800, category: 'Accesorios PS III' },
        { sku: 'SP1859', name: 'Tijeras de Cocina Precision Series', price: 3200, category: 'Accesorios PS III' },

        // FILTRACI√ìN y PURIFICACI√ìN (A√±adido)
        { sku: 'WA1010', name: 'Filtro de Agua (Con 1 Filtro)', price: 24000, category: 'Filtraci√≥n y Purificaci√≥n' },
        { sku: 'WA2020', name: 'Filtro de Agua (Con 2 Filtros)', price: 32000, category: 'Filtraci√≥n y Purificaci√≥n' }, // Se asigna SKU gen√©rico
        { sku: 'WA1011', name: 'Cartuchos de Reemplazo para Filtro de Agua (2 Pzs)', price: 16000, category: 'Filtraci√≥n y Purificaci√≥n' },
        { sku: 'WA1012', name: 'Cartuchos de Reemplazo para Filtro de Agua (3 Pzs)', price: 24000, category: 'Filtraci√≥n y Purificaci√≥n' },
        // Purificador de Aire (A√±adido)
        { sku: 'AP2101', name: 'Purificador de Aire Earth+ C/Cable', price: 90000, category: 'Filtraci√≥n y Purificaci√≥n' },
        { sku: 'AP2004', name: 'Cartuchos de Reemplazo Earth+', price: 21000, category: 'Filtraci√≥n y Purificaci√≥n' },

        // PIEZAS DE REEMPLAZO (A√±adido)
        { sku: 'RP4800', name: 'Agarradera Mediana Para Tapa-Innove', price: 1500, category: 'Piezas de Reemplazo' },
        { sku: 'RP4801', name: 'Agarradera Grande Para Tapa-Innove', price: 1600, category: 'Piezas de Reemplazo' },
        { sku: 'RP4802', name: 'V√°lvula Innove', price: 1000, category: 'Piezas de Reemplazo' },
        { sku: 'RP4810', name: 'Asa Lateral Desmontable Innove', price: 1000, category: 'Piezas de Reemplazo' },
        { sku: 'RP4811', name: 'Asa Larga Desmontable Innove', price: 2800, category: 'Piezas de Reemplazo' },

        // PRODUCTOS AGRUPADOS (Se manejan como kits predefinidos de venta)
        { sku: 'A1', name: 'Juego complementario (AGRUPADO)', price: 133700, category: 'Kits Predefinidos' },
        { sku: 'A2', name: 'Juego Cl√°sico (7 Pzs.) + tapa (AGRUPADO)', price: 150000, category: 'Kits Predefinidos' },
        { sku: 'A3', name: 'Extractor completo (AGRUPADO)', price: 135000, category: 'Kits Predefinidos' },
        
        // SOLUCIONES KIT
        { sku: 'S1', name: 'Kit de inicio: Paellera peque√±a / Sart√©n gourmet mediano de 10"', price: 64500, category: 'Kits Predefinidos' },
        { sku: 'S2', name: 'Kit b√°sico: Olla 4qt con tapa, Paellera peq.+ Sart√©n gourmet med. 10"', price: 104300, category: 'Kits Predefinidos' },
        
        // COMBO TEAMS
        { sku: 'C1', name: 'Combo especial : Juego de olla especial + Sart√©n gourmet', price: 197500, category: 'Kits Predefinidos' },
        // PRECIO CORREGIDO de 79700 a 179700
        { sku: 'C2', name: 'Combo complementario: Juego complement + Sart√©n gourme med + Greca gr.', price: 179700, category: 'Kits Predefinidos' },

        // Productos de Regalo de la Lista de Regalos (Manteniendo los SKU originales con la categor√≠a Regalo)
        { sku: 'PR2134G', name: 'Kit Completo Barista RT (REGALO)', price: '5000', category: 'Regalo' },
        { sku: 'SP0136G', name: 'Juego de 2 Tazas 16 oz. con Pared Doble (REGALO)', price: '5000', category: 'Regalo' }, // SKU modificado para evitar conflicto con SP0136 de Otros
        { sku: 'SP0135G', name: 'Juego de 4 Tazas Con Pared de Doble (REGALO)', price: '6500', category: 'Regalo' }, // SKU modificado para evitar conflicto con SP0135 de Otros
        { sku: 'PR0021G', name: 'Tabla Peque√±a P/Cortar de Bamb√∫ (REGALO)', price: '6500', category: 'Regalo' }, // SKU modificado para evitar conflicto con PR0021 de Cuchiller√≠a
        { sku: 'SP0262G', name: 'Jgo 2 Taz√≥nes P/Mezclar con Silicona (REGALO)', price: '7300', category: 'Regalo' }, // SKU modificado para evitar conflicto con SP0262 de Recipientes
        { sku: 'SP0066G', name: 'Taz√≥n Mezclar De 10 QT C/Tapa (REGALO)', price: '8000', category: 'Regalo' }, // SKU modificado para evitar conflicto con SP0066 de Recipientes
        { sku: 'PR0025G', name: 'Aro 35 cm. y ventana Innove + Perfect Pop (REGALO)', price: '8000', category: 'Regalo' }, // SKU modificado para evitar conflicto con PR0025 de Accesorios
        { sku: 'CU0825G', name: 'Hacha de Cocina (REGALO)', price: '8000', category: 'Regalo' }, // SKU modificado para evitar conflicto con CU0825 de Cuchiller√≠a
        { sku: 'PR0008G', name: 'Tabla de Bamb√∫ con Borde Silicona (REGALO)', price: '8200', category: 'Regalo' }, // SKU modificado para evitar conflicto con PR0008 de Cuchiller√≠a
        { sku: 'PR2675', name: 'Hervidor 1/2 Cuarto - Mango Negro (REGALO)', price: '8500', category: 'Regalo' }, // Mantenido, el otro hervidor tiene diferente SKU
        { sku: 'PR0609', name: 'Juego Cubiertos Americano - 24 Pzas (REGALO)', price: '9000', category: 'Regalo' },
        { sku: 'PR2685', name: 'Hervidor 1 Cuarto - Mango Negro (REGALO)', price: '9500', category: 'Regalo' },
        { sku: 'PR0196G', name: 'Juego de Utensilios de Cocina - 6 Pzas (REGALO)', price: '10700', category: 'Regalo' }, // SKU modificado para evitar conflicto con PR0196 de Otros
        { sku: 'PR2128', name: 'Cafetera Royal Espresso (REGALO)', price: '14000', category: 'Regalo' },
        { sku: 'PR2124', name: 'Cacerola Royal Prestige (REGALO)', price: '14000', category: 'Regalo' },
    ];
    
    // Obtener elementos del DOM
    const productList = document.getElementById('product-list');
    const quoteItemsDisplay = document.getElementById('quote-items');
    const subtotalDisplay = document.getElementById('subtotal-display');
    const discountPercentageInput = document.getElementById('discount-percentage');
    const discountAmountDisplay = document.getElementById('discount-amount-display');
    const totalDisplay = document.getElementById('total-display');
    const interestRateInput = document.getElementById('interest-rate');
    const initialPaymentInput = document.getElementById('initial-payment');
    const initialPaymentPercentDisplay = document.getElementById('initial-payment-percent-display');
    const amountFinancedDisplay = document.getElementById('amount-financed-display');
    const monthlyPaymentDisplay = document.getElementById('monthly-payment-display');
    const emptyQuoteMessage = document.getElementById('empty-quote-message');
    const categoryFilter = document.getElementById('category-filter');
    const searchInput = document.getElementById('product-search');
    const clearQuoteButton = document.getElementById('clear-quote-button');
    // Elementos para control de regalo
    const giftTotalDisplay = document.getElementById('gift-total-display');
    const giftMaxDisplay = document.getElementById('gift-max-display');
    const giftWarningMessage = document.getElementById('gift-warning-message');
    // Nuevo elemento para advertencia de pago inicial m√≠nimo
    const initialPaymentWarning = document.getElementById('initial-payment-warning');

    // --- Funciones de Renderizado ---
    
    // 1. Renderiza el cat√°logo de productos con filtros
    function renderProductList(searchTerm = '', category = '') {
        // Limpia la lista actual
        productList.innerHTML = '';
        if (productCatalog.length === 0) {
            productList.innerHTML = '<p class="text-center text-gray-500 pt-4">No hay productos disponibles.</p>';
            return;
        }

        const searchLower = searchTerm.toLowerCase().trim();
        const filteredProducts = productCatalog.filter(product => {
            const matchesSearch = product.name.toLowerCase().includes(searchLower) || product.sku.toLowerCase().includes(searchLower);
            const matchesCategory = category === '' || product.category === category;
            return matchesSearch && matchesCategory;
        });

        if (filteredProducts.length === 0) {
            productList.innerHTML = `<p class="text-center text-gray-500 pt-4">No se encontraron productos para "${searchTerm}" en esta categor√≠a.</p>`;
            return;
        }

        filteredProducts.forEach(product => {
            const isGift = product.category === 'Regalo';
            const priceValue = parseFloat(product.price) || 0; // Asegurarse de parsear si es string
            
            const productCard = document.createElement('div');
            productCard.className = `flex items-center justify-between p-3 rounded-lg border shadow-sm hover:shadow-md transition duration-200 ${isGift ? 'bg-yellow-100 border-yellow-300' : 'bg-gray-50 border-gray-200'}`;
            productCard.innerHTML = `
                <div class="flex flex-col">
                    <span class="font-semibold text-gray-800">${product.name}</span>
                    <span class="text-xs ${isGift ? 'text-yellow-700 font-bold' : 'text-gray-500'}"> 
                        SKU: ${product.sku} | ${isGift ? 'üéÅ REGALO (Para control)' : product.category} 
                    </span>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-lg font-bold ${isGift ? 'text-yellow-800' : 'text-emerald-600'}">${formatter.format(priceValue)}</span>
                    <button data-sku="${product.sku}" class="add-to-quote-btn bg-emerald-500 text-white py-1 px-3 rounded-full text-sm font-medium hover:bg-emerald-600 transition duration-150 shadow-md">
                        A√±adir
                    </button>
                </div>
            `;
            productList.appendChild(productCard);
        });

        // A√±adir listeners a los nuevos botones de a√±adir
        document.querySelectorAll('.add-to-quote-btn').forEach(button => {
            button.addEventListener('click', handleAddToQuote);
        });
    }

    // 2. Renderiza la lista de productos en el resumen de cotizaci√≥n
    function renderQuoteItems() {
        quoteItemsDisplay.innerHTML = '';

        if (quote.items.length === 0) {
            emptyQuoteMessage.classList.remove('hidden');
            return;
        }
        emptyQuoteMessage.classList.add('hidden');

        quote.items.forEach((item, index) => {
            const isGift = item.product.category === 'Regalo';
            const priceValue = parseFloat(item.product.price) || 0; // Asegurarse de parsear si es string
            const totalItemPrice = priceValue * item.quantity;
            
            const itemDiv = document.createElement('div');
            itemDiv.className = `flex items-center justify-between text-sm ${isGift ? 'bg-yellow-100 text-yellow-800 font-semibold' : 'bg-gray-50 text-gray-700'} p-2 rounded border-l-4 ${isGift ? 'border-yellow-500' : 'border-emerald-500'}`;
            itemDiv.innerHTML = `
                <div class="flex flex-col truncate">
                    <span class="font-medium truncate">${item.product.name} ${isGift ? '(üéÅ Regalo)' : ''}</span>
                    <span class="text-xs ${isGift ? 'text-yellow-700' : 'text-gray-500'}">x${item.quantity} | ${formatter.format(priceValue)} c/u</span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="font-bold ${isGift ? 'text-yellow-800' : 'text-emerald-600'}">${formatter.format(totalItemPrice)}</span>
                    <button data-index="${index}" class="remove-item-btn text-red-500 hover:text-red-700 transition duration-150 p-1 rounded">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                            <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 0 0 6 3.75v.5H2.75a.75.75 0 0 0 0 1.5h.581l1.194 9.553A2.75 2.75 0 0 0 7.279 17.5h5.442a2.75 2.75 0 0 0 2.75-2.525l1.194-9.553h.581a.75.75 0 0 0 0-1.5H14V3.75A2.75 2.75 0 0 0 11.25 1h-2.5ZM10 6a.75.75 0 0 1 .75.75v6.5a.75.75 0 0 1-1.5 0v-6.5A.75.75 0 0 1 10 6Zm3.25 3.5a.75.75 0 0 0 0 1.5h.008a.75.75 0 0 0 0-1.5H13.25ZM6.75 10a.75.75 0 0 0-.75.75v.008a.75.75 0 0 0 1.5 0V10.75a.75.75 0 0 0-.75-.75Z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            `;
            quoteItemsDisplay.appendChild(itemDiv);
        });

        // A√±adir listeners a los nuevos botones de remover
        document.querySelectorAll('.remove-item-btn').forEach(button => {
            button.addEventListener('click', handleRemoveItem);
        });
    }

    // 3. Rellena las opciones de categor√≠as en el filtro
    function populateCategoryFilter() {
        const uniqueCategories = [...new Set(productCatalog.map(p => p.category))];
        
        // Mover 'Regalo' al final si existe
        const indexRegalo = uniqueCategories.indexOf('Regalo');
        if (indexRegalo > -1) {
            uniqueCategories.splice(indexRegalo, 1); // Removerlo de la posici√≥n actual
            uniqueCategories.push('Regalo'); // A√±adirlo al final
        }

        uniqueCategories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            categoryFilter.appendChild(option);
        });
    }

    // --- Funciones de Manejo de Eventos ---

    // Maneja la adici√≥n de un producto a la cotizaci√≥n
    function handleAddToQuote(event) {
        const sku = event.currentTarget.dataset.sku;
        const product = productCatalog.find(p => p.sku === sku);

        if (product) {
            const existingItem = quote.items.find(item => item.product.sku === sku);

            if (existingItem) {
                // Si ya existe, incrementa la cantidad
                existingItem.quantity += 1;
            } else {
                // Si no existe, lo a√±ade
                quote.items.push({ product, quantity: 1 });
            }

            // Recalcula y renderiza
            calculateQuote();
            renderQuoteItems();
        }
    }

    // Maneja la remoci√≥n de un producto de la cotizaci√≥n
    function handleRemoveItem(event) {
        const index = parseInt(event.currentTarget.dataset.index);

        if (index >= 0 && index < quote.items.length) {
            const item = quote.items[index];

            if (item.quantity > 1) {
                // Si hay m√°s de uno, decrementa la cantidad
                item.quantity -= 1;
            } else {
                // Si es el √∫ltimo, remueve el item
                quote.items.splice(index, 1);
            }

            // Recalcula y renderiza
            calculateQuote();
            renderQuoteItems();
        }
    }

    // Maneja el pago inicial con botones de porcentaje
    function handleInitialPreset(percent) {
        // Asegura que el valor total ya est√© calculado
        const total = parseFloat(totalDisplay.dataset.value) || 0;
        const initialPaymentAmount = total * (percent / 100);

        initialPaymentInput.value = initialPaymentAmount.toFixed(0);
        calculateQuote();
    }

    // Limpia toda la cotizaci√≥n
    function clearQuote() {
        quote.items = [];
        discountPercentageInput.value = '0';
        initialPaymentInput.value = '0';
        interestRateInput.value = '31'; // Restaurar valor por defecto
        document.querySelector('.term-radio[value="24"]').checked = true; // Restaurar plazo por defecto

        // Recalcular y renderizar
        renderQuoteItems();
        calculateQuote();
    }

    // --- Funci√≥n Principal de C√°lculo ---
    function calculateQuote() {
        // 1. Obtener valores de entrada
        quote.discountPercentage = parseFloat(discountPercentageInput.value) || 0;
        quote.interestRate = parseFloat(interestRateInput.value) || 0;
        quote.initialPayment = parseFloat(initialPaymentInput.value) || 0;
        quote.termMonths = parseInt(document.querySelector('input[name="term"]:checked').value) || 24;

        // 2. Calcular Subtotal (Solo productos que NO son 'Regalo')
        const subtotalItems = quote.items.filter(item => item.product.category !== 'Regalo');
        // Importante: parseFloat se usa aqu√≠ para asegurar que los precios (que pueden ser strings) se traten como n√∫meros
        const subtotal = subtotalItems.reduce((sum, item) => sum + (parseFloat(item.product.price) * item.quantity), 0);

        // 3. Calcular Descuento
        const discountRate = quote.discountPercentage / 100;
        const discountAmount = subtotal * discountRate;
        
        // 4. Calcular Total Final (Capital)
        const total = subtotal - discountAmount;

        // 5. CALCULAR CONTROL DE REGALO POR VOLUMEN (10%)
        const giftItems = quote.items.filter(item => item.product.category === 'Regalo');
        // Importante: parseFloat se usa aqu√≠ para asegurar que los precios (que son strings) se traten como n√∫meros
        const totalGiftValue = giftItems.reduce((sum, item) => sum + (parseFloat(item.product.price) * item.quantity), 0);
        const maxGiftValue = total * GIFT_LIMIT_PERCENTAGE;

        // 6. Actualizar Display de Regalo
        giftTotalDisplay.textContent = formatter.format(totalGiftValue);
        giftMaxDisplay.textContent = formatter.format(maxGiftValue);
        giftWarningMessage.classList.remove('hidden');

        if (totalGiftValue > 0) {
            if (totalGiftValue > maxGiftValue) {
                const exceeded = totalGiftValue - maxGiftValue;
                giftWarningMessage.className = 'mt-3 p-3 text-center rounded-lg font-semibold bg-red-100 text-red-800';
                giftWarningMessage.innerHTML = `‚ö†Ô∏è ¬°ADVERTENCIA! El valor del regalo excede el l√≠mite (10%). Exceso de: <strong>${formatter.format(exceeded)}</strong>`;
            } else {
                giftWarningMessage.className = 'mt-3 p-3 text-center rounded-lg font-semibold bg-green-100 text-green-800';
                giftWarningMessage.textContent = '‚úÖ Valor del regalo dentro del l√≠mite permitido (10%).';
            }
        } else {
            if (total > 0) {
                giftWarningMessage.className = 'mt-3 p-3 text-center rounded-lg font-semibold bg-blue-100 text-blue-800';
                giftWarningMessage.textContent = 'A√∫n no se ha a√±adido un regalo de la lista.';
            } else {
                giftWarningMessage.classList.add('hidden');
            }
        }

        // 7. CALCULAR CONTROL DE PAGO INICIAL M√çNIMO (5%)
        const minInitialPayment = total * MINIMUM_INITIAL_PAYMENT_PERCENTAGE;
        if (total > 0 && quote.initialPayment > 0 && quote.initialPayment < minInitialPayment) {
            initialPaymentWarning.classList.remove('hidden');
        } else {
            initialPaymentWarning.classList.add('hidden');
        }


        // 8. Calcular Porcentaje de Pago Inicial
        let initialPaymentPercent = 0;
        if (total > 0) {
            initialPaymentPercent = (quote.initialPayment / total) * 100;
            if (initialPaymentPercent > 100) initialPaymentPercent = 100; // Cap at 100%
        }

        // 9. Calcular Financiamiento
        const amountFinanced = Math.max(0, total - quote.initialPayment);
        const rateMonthly = (quote.interestRate / 100) / 12; // Tasa de inter√©s mensual
        const n = quote.termMonths; // N√∫mero de pagos

        let monthlyPayment = 0;

        if (amountFinanced > 0 && rateMonthly > 0) {
            // F√≥rmula de pago mensual de un pr√©stamo (PMT)
            monthlyPayment = amountFinanced * (rateMonthly * Math.pow((1 + rateMonthly), n)) / (Math.pow((1 + rateMonthly), n) - 1);
        } else if (amountFinanced > 0 && rateMonthly === 0) {
            // Si la tasa de inter√©s es 0 (raro, pero para evitar divisi√≥n por cero)
             monthlyPayment = amountFinanced / n;
        } else {
            monthlyPayment = 0;
        }
        
        // 10. Actualizar el DOM
        subtotalDisplay.textContent = formatter.format(subtotal);
        discountAmountDisplay.textContent = formatter.format(-discountAmount);
        
        // Guardar el valor total en un data attribute para usarlo en handleInitialPreset
        totalDisplay.textContent = formatter.format(total);
        totalDisplay.dataset.value = total.toFixed(2); 

        // Actualizar Pago Inicial
        initialPaymentInput.max = total.toFixed(2); // No puede ser mayor al total
        if (total > 0 && quote.initialPayment > total) {
            // Si el pago inicial ingresado manualmente es mayor al total, lo limitamos
            initialPaymentInput.value = total.toFixed(0);
            quote.initialPayment = total; // Ajustar el valor de la variable
            initialPaymentPercent = 100;
        } else if (total === 0) {
            // Si el total es 0, el pago inicial debe ser 0
            initialPaymentInput.value = 0;
            quote.initialPayment = 0;
            initialPaymentPercent = 0;
        }

        initialPaymentPercentDisplay.textContent = `(${initialPaymentPercent.toFixed(1)}% del total)`;
        amountFinancedDisplay.textContent = formatter.format(amountFinanced);
        monthlyPaymentDisplay.textContent = formatter.format(monthlyPayment);
    }

// --- Funciones de WhatsApp ---

    // Funci√≥n para construir y enviar el mensaje de WhatsApp
    function sendQuoteByWhatsApp() {
        const clientNameInput = document.getElementById('client-name');
        const clientWhatsappInput = document.getElementById('client-whatsapp');

        const clientName = clientNameInput.value.trim() || 'Estimado(a) Cliente';
        const clientWhatsapp = clientWhatsappInput.value.replace(/[^0-9]/g, ''); // Limpiar solo d√≠gitos

        // 1. Construir Encabezado
        let message = `*COTIZACI√ìN ROYAL PRESTIGE HILAGO SRL*\n\n`;
        message += `Hola, ${clientName}. Aqu√≠ est√° el resumen de tu cotizaci√≥n:\n\n`;

        // 2. Lista de Productos
        if (quote.items.length > 0) {
            message += `*üõí Productos A√±adidos:*\n`;
            quote.items.forEach(item => {
                const isGift = item.product.category === 'Regalo';
                const priceValue = parseFloat(item.product.price) || 0;
                const totalItemPrice = priceValue * item.quantity;
                const priceText = isGift ? `(üéÅ Regalo: ${formatter.format(priceValue)})` : formatter.format(totalItemPrice);
                
                message += `- ${item.product.name} (x${item.quantity}): ${priceText}\n`;
            });
            message += `\n`;
        } else {
            message += `_La cotizaci√≥n est√° vac√≠a. A√±ade productos para ver el detalle._\n\n`;
        }

        // 3. Resumen de Precios
        const subtotal = parseFloat(subtotalDisplay.textContent.replace(/[$,]/g, '').trim()) || 0;
        const discountAmount = parseFloat(discountAmountDisplay.textContent.replace(/[$,-]/g, '').trim()) || 0;
        const total = parseFloat(totalDisplay.textContent.replace(/[$,]/g, '').trim()) || 0;

        message += `*üìä Resumen Financiero:*\n`;
        message += `Subtotal: ${formatter.format(subtotal)}\n`;
        message += `Descuento Aplicado (${quote.discountPercentage}%): -${formatter.format(discountAmount)}\n`;
        message += `\n*TOTAL A PAGAR (CAPITAL): ${formatter.format(total)}*\n`;
        
        // 4. Control de Regalo (Si aplica)
        const totalGiftValue = parseFloat(giftTotalDisplay.textContent.replace(/[$,]/g, '').trim()) || 0;
        if (totalGiftValue > 0) {
             const maxGiftValue = parseFloat(giftMaxDisplay.textContent.replace(/[$,]/g, '').trim()) || 0;
             const isOverLimit = totalGiftValue > maxGiftValue;

             message += `\n*üéÅ Control de Regalo:*\n`;
             message += `Valor Total de Regalos: ${formatter.format(totalGiftValue)}\n`;
             message += `M√°ximo Permitido (10%): ${formatter.format(maxGiftValue)}\n`;
             if (isOverLimit) {
                const exceeded = totalGiftValue - maxGiftValue;
                message += `üö® *¬°ADVERTENCIA! Excede por: ${formatter.format(exceeded)}*\n`;
             } else {
                 message += `‚úÖ Dentro del l√≠mite.\n`;
             }
        }
        
        // 5. Financiamiento (Si aplica un total > 0)
        if (total > 0 && total !== quote.initialPayment) {
            const amountFinanced = parseFloat(amountFinancedDisplay.textContent.replace(/[$,]/g, '').trim()) || 0;
            const monthlyPayment = parseFloat(monthlyPaymentDisplay.textContent.replace(/[$,]/g, '').trim()) || 0;
            const initialPaymentPercent = (quote.initialPayment / total) * 100;

            message += `\n*üí≥ Opciones de Financiamiento:*\n`;
            message += `Pago Inicial: ${formatter.format(quote.initialPayment)} (${initialPaymentPercent.toFixed(1)}%)\n`;
            message += `Monto a Financiar: ${formatter.format(amountFinanced)}\n`;
            message += `Plazo: ${quote.termMonths} meses\n`;
            message += `Tasa de Inter√©s Anual: ${quote.interestRate}%\n`;
            message += `\n*PAGO MENSUAL ESTIMADO: ${formatter.format(monthlyPayment)}*\n`;
            
            if (amountFinanced > 0 && amountFinanced < total && initialPaymentPercent < MINIMUM_INITIAL_PAYMENT_PERCENTAGE * 100) {
                 message += `\nüö® *Nota: El Pago Inicial m√≠nimo debe ser del ${MINIMUM_INITIAL_PAYMENT_PERCENTAGE * 100}% del Total a Pagar.*\n`;
            }
        } else if (total > 0 && total === quote.initialPayment && total !== 0) {
            message += `\n*Pagado al 100% de Contado. No aplica Financiamiento.*\n`;
        }

        // 6. Pie de P√°gina
        message += `\n_Para m√°s detalles o dudas, comun√≠cate con Hilago SRL al 809-893-6842._\n`;

        // Codificar el mensaje para la URL
        const encodedMessage = encodeURIComponent(message);
        
        // Determinar el n√∫mero de destino y el enlace
        const whatsappNumber = clientWhatsapp.length >= 10 ? clientWhatsapp : '8098936842'; // Usar el n√∫mero del cliente si es v√°lido, sino usar el de Hilago.
        const whatsappLink = `https://wa.me/${whatsappNumber}?text=${encodedMessage}`;

        // Abrir el enlace en una nueva pesta√±a
        window.open(whatsappLink, '_blank');
    }
    // --- Inicializaci√≥n ---
    document.addEventListener('DOMContentLoaded', () => {
        // Inicializar la lista de productos y filtros
        populateCategoryFilter();
        renderProductList();

        // Inicializar Tasa de Inter√©s al valor por defecto
        interestRateInput.value = '31';
        
        // Listeners para filtros
        searchInput.addEventListener('input', () => {
            renderProductList(searchInput.value, categoryFilter.value);
        });
        categoryFilter.addEventListener('change', () => {
            renderProductList(searchInput.value, categoryFilter.value);
        });

        // Listeners para modificaci√≥n de la cotizaci√≥n
        discountPercentageInput.addEventListener('input', calculateQuote);

        // Listeners para el financiamiento y pago inicial
        interestRateInput.addEventListener('input', calculateQuote); 
        initialPaymentInput.addEventListener('input', calculateQuote); 
        document.querySelectorAll('.term-radio').forEach(radio => {
            radio.addEventListener('change', calculateQuote);
        });
        
        // Listeners para botones de porcentaje inicial
        document.querySelectorAll('.preset-initial-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                handleInitialPreset(parseInt(btn.dataset.percent));
            });
        });
        
        // Listener para el bot√≥n de limpiar
        clearQuoteButton.addEventListener('click', clearQuote);
        
        // Listener para el bot√≥n de enviar por WhatsApp
        document.getElementById('send-whatsapp-button').addEventListener('click', sendQuoteByWhatsApp);

        // Llama a calculateQuote para que todos los displays se inicialicen correctamente
        calculateQuote();
    });

</script>

</body>
</html>
